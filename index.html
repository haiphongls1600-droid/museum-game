<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Museum – Long Rooms + Auto Door</title>
<style>
body{
  margin:0;
  background:#1e1e1e;
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
canvas{ background:#2b2b2b; }
</style>
</head>
<body>

<canvas id="game" width="900" height="700"></canvas>

<script>
// ================= SETUP =================
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const keys = {};
document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);

// ================= PLAYER =================
const player = { x:540, y:900, w:24, h:24, speed:3 };

// ================= CAMERA =================
const cam = {x:0,y:0};

// ================= MAP (PHÒNG DÀI 2.5x) =================
const ROOM_W = 420;
const ROOM_H = 1000; // dài hơn ~2.5 lần

const rooms = [
  {x:400,y:800,w:ROOM_W,h:ROOM_H},   // trung tâm
  {x:400,y:-300,w:ROOM_W,h:ROOM_H},  // bắc
  {x:400,y:2100,w:ROOM_W,h:ROOM_H},  // nam
  {x:-100,y:800,w:ROOM_W,h:ROOM_H},  // tây
  {x:900,y:800,w:ROOM_W,h:ROOM_H}    // đông
];

const halls = [
  {x:560,y:500,w:80,h:300},
  {x:560,y:1800,w:80,h:300},
  {x:300,y:1300,w:300,h:80},
  {x:800,y:1300,w:300,h:80}
];

// ================= WALLS =================
const walls = [];
const T = 14;

rooms.forEach(r=>{
  walls.push({x:r.x,y:r.y,w:r.w,h:T});
  walls.push({x:r.x,y:r.y,w:T,h:r.h});
  walls.push({x:r.x+r.w-T,y:r.y,w:T,h:r.h});
  walls.push({x:r.x,y:r.y+r.h-T,w:r.w,h:T});
});

// ================= DOORS (AUTO OPEN) =================
const doors = [
  {x:560,y:800,w:80,h:T,open:0},
  {x:560,y:800+ROOM_H-T,w:80,h:T,open:0},
  {x:400,y:1300,w:T,h:80,open:0},
  {x:400+ROOM_W-T,y:1300,w:T,h:80,open:0}
];

// ================= SHELVES =================
const shelves = [
  {x:540,y:1200,w:120,h:20,text:"Hiện vật trung tâm"},
  {x:540,y:-100,w:120,h:20,text:"Bộ sưu tập cổ"},
  {x:540,y:2500,w:120,h:20,text:"Triển lãm hiện đại"}
];

// ================= STATE =================
let popup = null;
let target = null;

// ================= UTILS =================
function hit(a,b){
  return a.x < b.x+b.w &&
         a.x+a.w > b.x &&
         a.y < b.y+b.h &&
         a.y+a.h > b.y;
}

function distance(a,b){
  return Math.hypot(
    (a.x+a.w/2)-(b.x+b.w/2),
    (a.y+a.h/2)-(b.y+b.h/2)
  );
}

function move(dx,dy){
  player.x += dx;
  for(const w of walls) if(hit(player,w)){ player.x -= dx; break; }
  for(const d of doors) if(d.open < 0.6 && hit(player,d)){ player.x -= dx; break; }

  player.y += dy;
  for(const w of walls) if(hit(player,w)){ player.y -= dy; break; }
  for(const d of doors) if(d.open < 0.6 && hit(player,d)){ player.y -= dy; break; }
}

// ================= INPUT =================
document.addEventListener("keydown",e=>{
  if(e.key==="e"){
    for(const s of shelves) if(hit(player,s)) popup = s.text;
  }
});

canvas.addEventListener("mousedown",e=>{
  if(popup) return;
  const r = canvas.getBoundingClientRect();
  target = {
    x:e.clientX-r.left+cam.x-player.w/2,
    y:e.clientY-r.top+cam.y-player.h/2
  };
});

canvas.addEventListener("click",()=>popup=null);

// ================= MOVE TO TARGET =================
function moveToTarget(){
  if(!target) return;
  const dx = target.x-player.x;
  const dy = target.y-player.y;
  const d = Math.hypot(dx,dy);
  if(d < 2){ target=null; return; }
  move((dx/d)*player.speed,(dy/d)*player.speed);
}

// ================= DRAW =================
function drawRect(r,c){
  ctx.fillStyle=c;
  ctx.fillRect(r.x-cam.x,r.y-cam.y,r.w,r.h);
}

// ================= LOOP =================
function loop(){

  // Door auto open
  doors.forEach(d=>{
    const dist = distance(player,d);
    if(dist < 90) d.open = Math.min(1, d.open + 0.05);
    else d.open = Math.max(0, d.open - 0.05);
  });

  if(!popup){
    if(keys.w){ move(0,-player.speed); target=null; }
    if(keys.s){ move(0, player.speed); target=null; }
    if(keys.a){ move(-player.speed,0); target=null; }
    if(keys.d){ move( player.speed,0); target=null; }
    moveToTarget();
  }

  cam.x = player.x - canvas.width/2;
  cam.y = player.y - canvas.height/2;

  ctx.clearRect(0,0,canvas.width,canvas.height);

  rooms.forEach(r=>drawRect(r,"#e6dfbf"));
  halls.forEach(h=>drawRect(h,"#d6cfaa"));
  walls.forEach(w=>drawRect(w,"#444"));

  doors.forEach(d=>{
    const openSize = d.h === T ? d.h*(1-d.open) : d.w*(1-d.open);
    ctx.fillStyle="#222";
    if(d.h === T)
      ctx.fillRect(d.x-cam.x, d.y-cam.y+openSize/2, d.w, openSize);
    else
      ctx.fillRect(d.x-cam.x+openSize/2, d.y-cam.y, openSize, d.h);
  });

  shelves.forEach(s=>drawRect(s,"#8c5a28"));
  drawRect(player,"#4aa3ff");

  if(popup){
    ctx.fillStyle="rgba(0,0,0,0.5)";
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.fillStyle="#fff";
    ctx.fillRect(220,220,460,240);
    ctx.fillStyle="#000";
    ctx.font="20px Arial";
    ctx.fillText(popup,260,340);
  }

  requestAnimationFrame(loop);
}

loop();
</script>
</body>
</html>
